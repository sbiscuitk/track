<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¥¼å¹²äº¤æ˜“è®¡åˆ’è®°å½•</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Load Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ï¼Œå¢å¼ºç§»åŠ¨ç«¯ä½“éªŒ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        /* P&L é¢œè‰²æ ·å¼ */
        .pnl-positive { color: #10b981; } /* ç»¿è‰² - ç›ˆåˆ© */
        .pnl-negative { color: #ef4444; } /* çº¢è‰² - äºæŸ */
        .pnl-zero { color: #9ca3af; } /* ç°è‰² - é›¶ */

        .summary-header {
            cursor: pointer;
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.2s;
        }
        .summary-header:hover {
            background-color: #f9fafb;
        }
        .summary-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .summary-content.open {
            max-height: 1000px; /* è¶³å¤Ÿå¤§çš„å€¼ */
            transition: max-height 0.5s ease-in;
        }
        .disabled-form button {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .disabled-form input, .disabled-form textarea {
            pointer-events: none;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="app" class="max-w-xl mx-auto p-4 md:p-6">
        <!-- å¤´éƒ¨ -->
        <header class="mb-6 pb-4 border-b border-gray-200">
            <h1 class="3xl font-bold text-gray-800">äº¤æ˜“è®¡åˆ’ä¸ç›ˆäºè®°å½•</h1>
            <p class="text-sm text-gray-500 mt-1" id="user-info">åŠ è½½ç”¨æˆ·...</p>
        </header>

        <!-- æ–°è®¡åˆ’è¡¨å• -->
        <section class="bg-white p-4 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">è®°å½•æ–°çš„äº¤æ˜“è®¡åˆ’</h2>
            <form id="plan-form" class="space-y-4">
                <div>
                    <label for="date" class="block text-sm font-medium text-gray-700">æ—¥æœŸ</label>
                    <input type="date" id="date" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <div>
                    <label for="product" class="block text-sm font-medium text-gray-700">äº¤æ˜“å“ç§ (ä¾‹å¦‚ï¼šèºçº¹é’¢, æ²ªæ·±300)</label>
                    <input type="text" id="product" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="å¿…å¡«ï¼Œå¦‚: RB, IF, CU">
                </div>
                <div>
                    <label for="plan" class="block text-sm font-medium text-gray-700">æ“ä½œè®¡åˆ’ (ä¾‹å¦‚ï¼šè§‚å¯Ÿ, 10ç‚¹è‹¥çªç ´å‹åŠ›ä½åˆ™å¼€å¤š)</label>
                    <textarea id="plan" rows="3" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                </div>
                <div>
                    <label for="expected-pnl" class="block text-sm font-medium text-gray-700">é¢„æœŸç›ˆäºé‡‘é¢ (å…ƒ/äººæ°‘å¸, å¡«0è¡¨ç¤ºè§‚å¯Ÿ)</label>
                    <input type="number" id="expected-pnl" step="0.01" value="0" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <button type="submit" id="save-plan-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    ä¿å­˜è®¡åˆ’
                </button>
            </form>
        </section>

        <!-- äº¤æ˜“æ•°æ®æ±‡æ€» -->
        <section class="mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 flex justify-between items-center">
                äº¤æ˜“æ•°æ®æ±‡æ€» (å·²æ“ä½œ)
                <!-- æ–°å¢å¯è§†åŒ–æŒ‰é’® -->
                <button id="show-charts-btn" class="text-sm text-white bg-green-500 hover:bg-green-600 px-3 py-1 rounded-lg transition duration-150 shadow-md disabled:opacity-50" disabled>
                    ğŸ“Š å¯è§†åŒ–åˆ†æ
                </button>
            </h2>
            <div id="summary-section" class="bg-white rounded-xl shadow-lg">
                <p class="text-center text-gray-500 p-4" id="summary-message">æ­£åœ¨è®¡ç®—æ±‡æ€»...</p>
            </div>
        </section>

        <!-- è®¡åˆ’åˆ—è¡¨ -->
        <section class="mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">æˆ‘çš„æ¯æ—¥è®°å½•</h2>
            <!-- ç­›é€‰æ—¥æœŸè¾“å…¥æ¡† -->
            <div class="mb-4 bg-white p-3 rounded-xl shadow-inner border border-gray-100">
                <label for="filter-date" class="block text-sm font-medium text-gray-700 mb-2">ç­›é€‰æ—¥æœŸ</label>
                <input type="date" id="filter-date" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
            </div>
            <!-- /ç­›é€‰æ—¥æœŸè¾“å…¥æ¡† -->
            <div id="plans-list" class="space-y-4">
                <p class="text-center text-gray-500" id="loading-message">æ­£åœ¨åŠ è½½è®°å½•...</p>
            </div>
        </section>

        <!-- æ¶ˆæ¯æç¤ºå®¹å™¨ -->
        <div id="message-container" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 p-3 bg-red-500 text-white rounded-lg shadow-xl hidden transition-opacity duration-300"></div>

    </div>

    <!-- å¯è§†åŒ–æ¨¡æ€æ¡† (Modal) -->
    <div id="chart-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-start justify-center z-50 p-4 hidden">
        <div class="bg-white w-full max-w-4xl rounded-xl shadow-2xl mt-8 transform transition-all overflow-y-auto max-h-[90vh]">
            <div class="p-6 border-b border-gray-200 sticky top-0 bg-white z-10 rounded-t-xl flex justify-between items-center">
                <h3 class="text-2xl font-bold text-gray-800">äº¤æ˜“ç›ˆäºå¯è§†åŒ–åˆ†æ</h3>
                <button id="close-charts-btn" class="text-gray-500 hover:text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="p-6 space-y-8">
                <!-- æ¯æ—¥ç›ˆäºå›¾è¡¨ -->
                <div class="bg-gray-50 p-4 rounded-lg shadow-md">
                    <h4 class="text-xl font-semibold mb-3 text-gray-700">æ¯æ—¥å‡€ç›ˆäºè¶‹åŠ¿ (å…ƒ)</h4>
                    <div class="relative h-64 md:h-80">
                        <canvas id="dailyPnlChart"></canvas>
                    </div>
                </div>

                <!-- æŒ‰å“ç§ç›ˆäºå›¾è¡¨ -->
                <div class="bg-gray-50 p-4 rounded-lg shadow-md">
                    <h4 class="text-xl font-semibold mb-3 text-gray-700">æŒ‰å“ç§å‡€ç›ˆäºæ±‡æ€» (å…ƒ)</h4>
                    <div class="relative h-64 md:h-80">
                        <canvas id="productPnlChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs å’Œ è„šæœ¬ -->
    <script type="module">
        // æ›´æ–° SDK ç‰ˆæœ¬åˆ° 12.6.0
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import {
            getFirestore, collection, query, onSnapshot,
            doc, addDoc, updateDoc, deleteDoc, serverTimestamp
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        // --- å…¨å±€å˜é‡å’Œé…ç½® (æœ¬åœ°ç¡¬ç¼–ç é…ç½®) ---
        // è¿™æ˜¯ç”¨æˆ·æä¾›çš„ Firebase é…ç½®ä¿¡æ¯
        const firebaseConfig = {
            apiKey: "AIzaSyCIMADKl5WAhyfjTocExy0wmvAwb8FrYqY",
            authDomain: "qihuo-87146.firebaseapp.com",
            projectId: "qihuo-87146",
            storageBucket: "qihuo-87146.firebasestorage.app",
            messagingSenderId: "373388946324",
            appId: "1:373388946324:web:5255ea409822fe26127d81",
            measurementId: "G-Z38SXNHHKC"
        };

        // ä½¿ç”¨ projectId ä½œä¸ºåº”ç”¨ ID
        const appId = firebaseConfig.projectId;

        let app, db, auth, userId;
        let isAuthReady = false;

        // å…¨å±€çŠ¶æ€ç®¡ç†
        let allPlansCache = [];
        let currentFilterDate = new Date().toISOString().substring(0, 10);

        // Chart.js å®ä¾‹å˜é‡
        let dailyChartInstance = null;
        let productChartInstance = null;

        const plansList = document.getElementById('plans-list');
        const planForm = document.getElementById('plan-form');
        const userInfoEl = document.getElementById('user-info');
        const loadingMessageEl = document.getElementById('loading-message');
        const messageContainer = document.getElementById('message-container');
        const summarySection = document.getElementById('summary-section');
        const summaryMessageEl = document.getElementById('summary-message');
        const filterDateInput = document.getElementById('filter-date');
        const savePlanBtn = document.getElementById('save-plan-btn');
        const showChartsBtn = document.getElementById('show-charts-btn');
        const chartModal = document.getElementById('chart-modal');
        const closeChartsBtn = document.getElementById('close-charts-btn');

        // --- å®ç”¨å‡½æ•° ---

        /**
         * æ˜¾ç¤ºä¸€ä¸ªçŸ­æš‚çš„æ¶ˆæ¯æç¤ºã€‚
         * @param {string} message - æ¶ˆæ¯æ–‡æœ¬ã€‚
         * @param {string} type - 'success' æˆ– 'error'ã€‚
         */
        function showMessage(message, type = 'success') {
            messageContainer.textContent = message;
            messageContainer.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 p-3 text-white rounded-lg shadow-xl transition-opacity duration-300 z-50 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
            messageContainer.classList.remove('hidden');
            setTimeout(() => {
                messageContainer.classList.add('hidden');
            }, 3000);
        }

        /**
         * æ ¼å¼åŒ–ç›ˆäºå€¼ï¼Œå¹¶æ·»åŠ é¢œè‰²å’Œç¬¦å·ã€‚
         * @param {number} pnl - ç›ˆäºå€¼ã€‚
         * @returns {string} å¸¦æœ‰æ ·å¼ç›ˆäºçš„ HTML å­—ç¬¦ä¸²ã€‚
         */
        function formatPnl(pnl) {
            const num = parseFloat(pnl);
            if (isNaN(num)) {
                return '<span class="text-gray-500">Â¥ N/A</span>';
            }
            if (num === 0) {
                return '<span class="pnl-zero">Â¥ 0.00</span>';
            }
            const colorClass = num > 0 ? 'pnl-positive' : 'pnl-negative';
            const sign = num > 0 ? '+' : '';
            return `<span class="${colorClass} font-semibold">Â¥ ${sign}${num.toFixed(2)}</span>`;
        }

        /**
         * æ ¼å¼åŒ–æ•°é‡ã€‚
         * @param {number} count - æ•°é‡ã€‚
         * @returns {string} æ ¼å¼åŒ–åçš„æ•°é‡å­—ç¬¦ä¸²ã€‚
         */
        function formatCount(count) {
            return `<span class="text-gray-600">(${count} ç¬”)</span>`;
        }

        /**
         * æ ¹æ®è¿æ¥çŠ¶æ€ç¦ç”¨æˆ–å¯ç”¨è¡¨å•ã€‚
         * @param {boolean} disabled - æ˜¯å¦ç¦ç”¨ã€‚
         */
        function toggleFormDisabled(disabled) {
            if (disabled) {
                planForm.classList.add('disabled-form');
                savePlanBtn.disabled = true;
                savePlanBtn.textContent = 'æ— æ³•ä¿å­˜ (æ•°æ®åº“æœªè¿æ¥)';
            } else {
                planForm.classList.remove('disabled-form');
                savePlanBtn.disabled = false;
                savePlanBtn.textContent = 'ä¿å­˜è®¡åˆ’';
            }
        }


        // --- Firebase åˆå§‹åŒ–å’Œè®¤è¯ ---

        try {
            // å°è¯•ä½¿ç”¨è§£æåçš„é…ç½®è¿›è¡Œåˆå§‹åŒ–
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // è®¤è¯çŠ¶æ€ç›‘å¬å™¨
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userInfoEl.textContent = `ç”¨æˆ·ID: ${userId}`;
                    isAuthReady = true;
                    console.log("Authentication successful, userId:", userId);
                    toggleFormDisabled(false); // å¯ç”¨è¡¨å•
                    // è®¤è¯å®Œæˆåå¼€å§‹ç›‘å¬ Firestore æ•°æ®
                    setupRealtimeListener();
                } else {
                    // æœ¬åœ°è¿è¡Œæ—¶æ²¡æœ‰è‡ªå®šä¹‰ tokenï¼Œç›´æ¥è¿›è¡ŒåŒ¿åç™»å½•
                    try {
                        await signInAnonymously(auth);
                        // onAuthStateChanged ä¼šå†æ¬¡è§¦å‘ï¼Œå¹¶è®¾ç½® user/userId
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                        // é’ˆå¯¹ auth/configuration-not-found é”™è¯¯æä¾›å…·ä½“æŒ‡å¯¼
                        let authErrorMessage = 'è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“è§„åˆ™ã€‚';
                        if (error.code === 'auth/configuration-not-found') {
                            authErrorMessage = 'è®¤è¯å¤±è´¥ï¼šè¯·åœ¨ Firebase æ§åˆ¶å°æ£€æŸ¥ **èº«ä»½éªŒè¯** -> **ç™»å½•æ–¹æ³•** ä¸­æ˜¯å¦å¯ç”¨äº† **åŒ¿åç™»å½•**ã€‚';
                        }

                        showMessage(authErrorMessage, 'error');
                        userInfoEl.textContent = 'è®¤è¯å¤±è´¥';
                        toggleFormDisabled(true); // è®¤è¯å¤±è´¥ï¼Œç¦ç”¨è¡¨å•
                    }
                }
            });

        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            showMessage('Firebase åˆå§‹åŒ–å¤±è´¥: è¯·æ£€æŸ¥é…ç½®å’Œç½‘ç»œè¿æ¥ã€‚', 'error');
            userInfoEl.textContent = 'çŠ¶æ€: åˆå§‹åŒ–å¤±è´¥';
            loadingMessageEl.innerHTML = '<p class="text-red-500 font-semibold">âŒ åˆå§‹åŒ–å¤±è´¥ã€‚è¯·æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®ã€‚</p>';
            summarySection.innerHTML = '<p class="text-center text-gray-500 p-4">æ•°æ®åº“è¿æ¥å¤±è´¥ã€‚</p>';
            toggleFormDisabled(true); // åˆå§‹åŒ–å¤±è´¥ï¼Œç¦ç”¨è¡¨å•
        }


        // --- Firestore æ“ä½œ ---

        /**
         * è·å– Firestore é›†åˆå¼•ç”¨ã€‚
         * @returns {object} Collection reference.
         */
        function getCollectionRef() {
            if (!userId) throw new Error("ç”¨æˆ·æœªè®¤è¯ã€‚");
            // å­˜å‚¨è·¯å¾„: /artifacts/{appId}/users/{userId}/futures_plans
            const path = `/artifacts/${appId}/users/${userId}/futures_plans`;
            return collection(db, path);
        }

        /**
         * å¤„ç†ä¿å­˜æ–°è®¡åˆ’ã€‚
         */
        planForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) {
                showMessage('æ•°æ®åº“æœªè¿æ¥æˆ–ç”¨æˆ·è®¤è¯ä¸­ï¼Œæ— æ³•ä¿å­˜ã€‚', 'error');
                return;
            }

            const date = document.getElementById('date').value;
            const product = document.getElementById('product').value.trim(); // æ–°å¢å“ç§å­—æ®µ
            const plan = document.getElementById('plan').value.trim();
            const expectedPnl = parseFloat(document.getElementById('expected-pnl').value);

            if (!date || !product || !plan || isNaN(expectedPnl)) {
                showMessage('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µã€‚', 'error');
                return;
            }

            try {
                // æ–°å¢ä¿å­˜ grossPnl å’Œ fees å­—æ®µï¼Œåˆå§‹ä¸º 0
                await addDoc(getCollectionRef(), {
                    date: date,
                    product: product,
                    plan: plan,
                    expectedPnl: expectedPnl,
                    occurred: false,
                    actualPnl: 0,
                    grossPnl: 0, // æ–°å¢ï¼šç›ˆäºï¼ˆç¨å‰/å‰ï¼‰
                    fees: 0,       // æ–°å¢ï¼šæ‰‹ç»­è´¹
                    timestamp: serverTimestamp()
                });

                showMessage('äº¤æ˜“è®¡åˆ’ä¿å­˜æˆåŠŸï¼');
                planForm.reset();
                // ä¸ºæ–¹ä¾¿èµ·è§ï¼Œå°†æ—¥æœŸé¢„è®¾ä¸ºä»Šå¤©
                document.getElementById('date').value = new Date().toISOString().substring(0, 10);

            } catch (error) {
                console.error("Error adding document: ", error);
                showMessage('ä¿å­˜è®¡åˆ’å¤±è´¥: ' + error.message, 'error');
            }
        });

        /**
         * æ›´æ–°ç°æœ‰è®¡åˆ’ï¼ˆæ˜¯å¦æ“ä½œçŠ¶æ€ã€ç›ˆäºã€æ‰‹ç»­è´¹å’Œå®é™…å‡€ç›ˆäºï¼‰ã€‚
         * @param {string} docId - è¦æ›´æ–°çš„æ–‡æ¡£ IDã€‚
         * @param {boolean} occurred - 'æ˜¯å¦æ“ä½œ' çš„æ–°çŠ¶æ€ã€‚
         * @param {number} grossPnl - ç›ˆäºï¼ˆç¨å‰/å‰ï¼‰ã€‚
         * @param {number} fees - æ‰‹ç»­è´¹ã€‚
         * @param {number} actualPnl - å®é™…å‡€ç›ˆäº (grossPnl - fees)ã€‚
         */
        async function updatePlan(docId, occurred, grossPnl, fees, actualPnl) {
            if (!isAuthReady) {
                showMessage('æ•°æ®åº“æœªè¿æ¥æˆ–ç”¨æˆ·è®¤è¯ä¸­ï¼Œæ— æ³•æ›´æ–°ã€‚', 'error');
                return;
            }
            try {
                const planRef = doc(getCollectionRef(), docId);
                await updateDoc(planRef, {
                    occurred: occurred,
                    grossPnl: grossPnl, // æ›´æ–° grossPnl
                    fees: fees,         // æ›´æ–° fees
                    actualPnl: actualPnl // æ›´æ–°è®¡ç®—åçš„å‡€ç›ˆäº
                });
                showMessage('è®°å½•æ›´æ–°æˆåŠŸï¼');
            } catch (error) {
                console.error("Error updating document: ", error);
                showMessage('æ›´æ–°è®°å½•å¤±è´¥: ' + error.message, 'error');
            }
        }

        /**
         * åˆ é™¤è®¡åˆ’è®°å½•ã€‚
         * @param {string} docId - è¦åˆ é™¤çš„æ–‡æ¡£ IDã€‚
         */
        async function deletePlan(docId) {
            if (!isAuthReady) {
                showMessage('æ•°æ®åº“æœªè¿æ¥æˆ–ç”¨æˆ·è®¤è¯ä¸­ï¼Œæ— æ³•åˆ é™¤ã€‚', 'error');
                return;
            }
            // ç¡®ä¿ docId å­˜åœ¨
            if (!docId) {
                 console.error("Deletion Error: docId is undefined or empty.");
                 showMessage('åˆ é™¤å¤±è´¥ï¼šè®°å½•IDç¼ºå¤±ã€‚', 'error');
                 return;
            }

            try {
                const planRef = doc(getCollectionRef(), docId);
                await deleteDoc(planRef);
                showMessage('è®°å½•åˆ é™¤æˆåŠŸï¼');
            } catch (error) {
                console.error("Error deleting document: ", error);
                showMessage('åˆ é™¤è®°å½•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // --- æ±‡æ€»è®¡ç®—é€»è¾‘ (ä¿æŒä¸å˜) ---

        function generateSummaries(plans) {
            const summaries = {
                totalSummary: { actualPnl: 0, count: 0 },
                dailySummary: {},
                monthlySummary: {},
                annualSummary: {},
                productSummary: {}
            };

            plans.forEach(plan => {
                if (!plan.occurred) return;
                // ... (summary calculation logic) ...
                const pnl = parseFloat(plan.actualPnl || 0);
                const date = plan.date;
                const product = (plan.product || 'æœªåˆ†ç±»').trim() || 'æœªåˆ†ç±»';
                const year = date.substring(0, 4);
                const month = date.substring(0, 7);

                summaries.totalSummary.actualPnl += pnl;
                summaries.totalSummary.count++;

                summaries.dailySummary[date] = summaries.dailySummary[date] || { actualPnl: 0, count: 0 };
                summaries.dailySummary[date].actualPnl += pnl;
                summaries.dailySummary[date].count++;

                summaries.monthlySummary[month] = summaries.monthlySummary[month] || { actualPnl: 0, count: 0 };
                summaries.monthlySummary[month].actualPnl += pnl;
                summaries.monthlySummary[month].count++;

                summaries.annualSummary[year] = summaries.annualSummary[year] || { actualPnl: 0, count: 0 };
                summaries.annualSummary[year].actualPnl += pnl;
                summaries.annualSummary[year].count++;

                summaries.productSummary[product] = summaries.productSummary[product] || { actualPnl: 0, count: 0 };
                summaries.productSummary[product].actualPnl += pnl;
                summaries.productSummary[product].count++;
            });

            return summaries;
        }

        /**
         * æ¸²æŸ“æ±‡æ€»æ•°æ®åˆ°ç•Œé¢ä¸Šã€‚(ä¿æŒä¸å˜)
         */
        function renderSummaries(summaries) {
            const { totalSummary, dailySummary, monthlySummary, annualSummary, productSummary } = summaries;

            if (totalSummary.count === 0) {
                summarySection.innerHTML = '<p class="text-center text-gray-500 p-4">å°šæ— å·²æ“ä½œçš„è®°å½•ã€‚</p>';
                return;
            }

            // æ¸²æŸ“åˆ—è¡¨ (æ¯æ—¥/æ¯æœˆ/æ¯å¹´/å“ç§)
            const renderList = (data, titleKey) => {
                const keys = Object.keys(data).sort().reverse();
                if (keys.length === 0) return 'æ— è®°å½•';

                return keys.map(key => `
                    <div class="flex justify-between items-center py-2 px-3 hover:bg-gray-50 border-b border-gray-100 last:border-b-0">
                        <span class="text-gray-700 font-medium">${key}</span>
                        <div class="text-right">
                            ${formatPnl(data[key].actualPnl)}
                            ${formatCount(data[key].count)}
                        </div>
                    </div>
                `).join('');
            };

            // æ¸²æŸ“æŠ˜å é¢æ¿
            const renderCollapsible = (title, contentHTML, isTotal = false) => {
                const totalPnl = isTotal ? totalSummary.actualPnl : null;

                const headerContent = isTotal ? `
                    <div class="flex justify-between items-center w-full">
                        <span class="text-lg font-bold text-gray-800">æ€»è®¡ (${totalSummary.count} ç¬”)</span>
                        <span class="text-lg font-bold">${formatPnl(totalPnl)}</span>
                    </div>
                ` : `
                    <div class="flex justify-between items-center w-full">
                        <span class="font-medium text-gray-700">${title}</span>
                        <!-- Arrow icon -->
                        <svg class="h-4 w-4 text-gray-500 transition-transform duration-300 transform" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </div>
                `;

                return `
                    <div class="summary-item">
                        <div class="summary-header flex ${isTotal ? 'bg-indigo-50 border-none rounded-t-xl' : 'bg-white'}" data-target="${title.replace(/\s/g, '-')}-content" ${isTotal ? 'data-is-total="true"' : 'role="button" tabindex="0"'}>
                            ${headerContent}
                        </div>
                        <div id="${title.replace(/\s/g, '-')}-content" class="summary-content ${isTotal ? 'open' : ''} ${isTotal ? 'p-0' : 'p-0'}">
                            ${isTotal ? '' : contentHTML}
                        </div>
                    </div>
                `;
            };

            // æ„å»ºæœ€ç»ˆçš„ HTML ç»“æ„
            let html = '';

            html += renderCollapsible('æ€»è®¡æ±‡æ€»', '', true);
            html += renderCollapsible('æŒ‰å“ç§æ±‡æ€»', `<div class="p-2">${renderList(productSummary, 'product')}</div>`);
            html += renderCollapsible('æŒ‰å¹´ä»½æ±‡æ€»', `<div class="p-2">${renderList(annualSummary, 'year')}</div>`);
            html += renderCollapsible('æŒ‰æœˆä»½æ±‡æ€»', `<div class="p-2">${renderList(monthlySummary, 'month')}</div>`);
            html += renderCollapsible('æŒ‰æ¯æ—¥æ±‡æ€»', `<div class="p-2">${renderList(dailySummary, 'date')}</div>`);

            summarySection.innerHTML = html;

            // æ·»åŠ æŠ˜å åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨
            summarySection.querySelectorAll('.summary-header').forEach(header => {
                if (header.dataset.isTotal) return;

                header.addEventListener('click', (e) => {
                    const targetId = header.dataset.target;
                    const targetContent = document.getElementById(targetId);

                    const arrow = header.querySelector('svg');

                    if (targetContent.classList.contains('open')) {
                        targetContent.classList.remove('open');
                        arrow.style.transform = 'rotate(0deg)';
                    } else {
                        summarySection.querySelectorAll('.summary-content.open').forEach(content => {
                            content.classList.remove('open');
                        });
                        summarySection.querySelectorAll('.summary-header svg').forEach(svg => {
                            svg.style.transform = 'rotate(0deg)';
                        });

                        targetContent.classList.add('open');
                        arrow.style.transform = 'rotate(180deg)';
                    }
                });
            });

            const totalContent = document.getElementById('æ€»è®¡æ±‡æ€»-content');
            if (totalContent) {
                 totalContent.style.maxHeight = 'none';
                 totalContent.style.overflow = 'visible';
                 totalContent.classList.add('open');
            }
        }

        /**
         * æ¸²æŸ“æ¯æ—¥å’Œå“ç§ç›ˆäºå›¾è¡¨ã€‚
         * @param {object} summaries - æ±‡æ€»æ•°æ®å¯¹è±¡ã€‚
         */
        function renderCharts(summaries) {
            const { dailySummary, productSummary } = summaries;

            // ------------------- æ¯æ—¥ç›ˆäºå›¾è¡¨ (Daily PNL) -------------------

            const dailyLabels = Object.keys(dailySummary).sort();
            const dailyData = dailyLabels.map(date => dailySummary[date].actualPnl);
            const dailyColors = dailyData.map(pnl => pnl >= 0 ? '#10b981' : '#ef4444'); // Green for profit, Red for loss

            // é”€æ¯æ—§å®ä¾‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (dailyChartInstance) {
                dailyChartInstance.destroy();
            }

            dailyChartInstance = new Chart(document.getElementById('dailyPnlChart'), {
                type: 'bar',
                data: {
                    labels: dailyLabels,
                    datasets: [{
                        label: 'æ¯æ—¥å‡€ç›ˆäº (Â¥)',
                        data: dailyData,
                        backgroundColor: dailyColors,
                        borderColor: dailyColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'å‡€ç›ˆäº (Â¥)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ'
                            }
                        }
                    }
                }
            });

            // ------------------- æŒ‰å“ç§ç›ˆäºå›¾è¡¨ (Product PNL) -------------------

            const productLabels = Object.keys(productSummary).sort();
            const productData = productLabels.map(product => productSummary[product].actualPnl);
            const productColors = productData.map(pnl => pnl >= 0 ? '#3b82f6' : '#f97316'); // Blue/Orange colors

            // é”€æ¯æ—§å®ä¾‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (productChartInstance) {
                productChartInstance.destroy();
            }

            productChartInstance = new Chart(document.getElementById('productPnlChart'), {
                type: 'doughnut', // Use Doughnut or Pie chart for product breakdown
                data: {
                    labels: productLabels,
                    datasets: [{
                        label: 'æ€»å‡€ç›ˆäº (Â¥)',
                        data: productData,
                        backgroundColor: [
                            '#3b82f6', '#f97316', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });
        }


        // --- äº¤æ˜“è®°å½•æ¸²æŸ“å’Œäº‹ä»¶ç›‘å¬ ---

        /**
         * æ¸²æŸ“ç­›é€‰åçš„äº¤æ˜“è®°å½•åˆ—è¡¨ã€‚
         * @param {Array<object>} plans - æ‰€æœ‰äº¤æ˜“è®¡åˆ’æ•°ç»„ã€‚
         * @param {string} filterDate - YYYY-MM-DD æ ¼å¼çš„ç­›é€‰æ—¥æœŸã€‚
         */
        function renderPlansList(plans, filterDate) {
            plansList.innerHTML = '';

            // 1. ç­›é€‰æ•°æ®ï¼šåªä¿ç•™åŒ¹é…ç­›é€‰æ—¥æœŸçš„è®°å½•
            const filteredPlans = plans.filter(plan => plan.date === filterDate);

            // 2. æ’åºæ•°æ®ï¼šæŒ‰æ—¶é—´æˆ³é™åºæ’åºï¼ˆæœ€æ–°è®°å½•åœ¨å‰ï¼‰
            filteredPlans.sort((a, b) => {
                const timestampA = a.timestamp ? a.timestamp.toMillis() : 0;
                const timestampB = b.timestamp ? b.timestamp.toMillis() : 0;
                return timestampB - timestampA;
            });

            if (filteredPlans.length === 0) {
                plansList.innerHTML = `<p class="text-center text-gray-500 p-6 bg-white rounded-xl shadow">æ—¥æœŸ ${filterDate} æš‚æ— è®°å½•ã€‚</p>`;
                return;
            }

            filteredPlans.forEach((data) => {
                const docId = data.id;
                const grossPnl = data.grossPnl || 0;
                const fees = data.fees || 0;

                const card = document.createElement('div');
                card.className = `bg-white p-4 rounded-xl shadow-md border-l-4 ${data.occurred ? (data.actualPnl > 0 ? 'border-green-500' : (data.actualPnl < 0 ? 'border-red-500' : 'border-gray-400')) : 'border-blue-400'}`;

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-lg font-bold text-gray-800">${data.date} - ${data.product || 'æœªåˆ†ç±»'}</h3>
                        <button data-id="${docId}" class="delete-btn text-gray-400 hover:text-red-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>

                    <div class="mb-3 text-gray-600">
                        <strong class="text-gray-800">è®¡åˆ’:</strong> ${data.plan}
                    </div>

                    <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                        <div>
                            <strong class="text-gray-800">é¢„æœŸç›ˆäº:</strong>
                            ${formatPnl(data.expectedPnl)}
                        </div>
                        <div class="flex items-center">
                            <strong class="text-gray-800 mr-2">æ˜¯å¦æ“ä½œ:</strong>
                            <input type="checkbox" id="occurred-${docId}" data-id="${docId}" class="occurred-toggle h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="occurred-${docId}" class="ml-2 text-gray-700">${data.occurred ? 'å·²æ‰§è¡Œ' : 'æœªæ‰§è¡Œ'}</label>
                        </div>
                    </div>

                    <div id="actual-pnl-group-${docId}" class="${data.occurred ? 'block' : 'hidden'} mt-4 pt-3 border-t border-gray-100">
                        <strong class="text-gray-800">äº¤æ˜“ç»“æœ:</strong>
                        <div class="space-y-2 mt-1">
                            <div class="flex items-center">
                                <label for="gross-pnl-${docId}" class="w-1/3 text-sm text-gray-600">ç›ˆäº (ç¨å‰/å‰):</label>
                                <input type="number" id="gross-pnl-${docId}" value="${grossPnl}" step="0.01" data-id="${docId}" class="gross-pnl-input block w-2/3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border text-sm">
                            </div>
                            <div class="flex items-center">
                                <label for="fees-${docId}" class="w-1/3 text-sm text-gray-600">æ‰‹ç»­è´¹:</label>
                                <input type="number" id="fees-${docId}" value="${fees}" step="0.01" data-id="${docId}" class="fees-input block w-2/3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border text-sm">
                            </div>
                        </div>

                        <div class="flex justify-between items-center mt-3 pt-2 border-t border-gray-100">
                            <strong class="text-gray-800 text-sm">å®é™…å‡€ç›ˆäº:</strong>
                            <span id="net-pnl-display-${docId}" class="text-sm">${formatPnl(data.actualPnl)}</span>
                            <button data-id="${docId}" class="save-pnl-btn flex-shrink-0 bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-3 rounded-lg text-sm transition-colors">
                                æ›´æ–°ç»“ç®—
                            </button>
                        </div>
                        <p class="text-xs mt-1 text-gray-500">è®¡ç®—å…¬å¼: ç›ˆäº - æ‰‹ç»­è´¹</p>
                    </div>
                `;

                plansList.appendChild(card);

                const toggle = card.querySelector(`#occurred-${docId}`);
                if(toggle) {
                    toggle.checked = data.occurred;
                }
            });

            // 3. é‡æ–°ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            attachPlanListEventListeners();
        }

        /**
         * é‡æ–°ç»‘å®šåˆ—è¡¨é¡¹çš„äº‹ä»¶ç›‘å¬å™¨ã€‚
         */
        function attachPlanListEventListeners() {
             // å¤„ç†â€œæ˜¯å¦æ“ä½œâ€åˆ‡æ¢
            plansList.querySelectorAll('.occurred-toggle').forEach(toggle => {
                toggle.addEventListener('change', (e) => {
                    const docId = e.target.dataset.id;
                    const occurred = e.target.checked;
                    const actualPnlGroup = document.getElementById(`actual-pnl-group-${docId}`);

                    const grossPnlInput = document.getElementById(`gross-pnl-${docId}`);
                    const feesInput = document.getElementById(`fees-${docId}`);

                    if (occurred) {
                        actualPnlGroup.classList.remove('hidden');

                        const initialGrossPnl = parseFloat(grossPnlInput.value) || 0;
                        const initialFees = parseFloat(feesInput.value) || 0;
                        const initialNetPnl = initialGrossPnl - initialFees;

                        updatePlan(docId, occurred, initialGrossPnl, initialFees, initialNetPnl);
                    } else {
                        actualPnlGroup.classList.add('hidden');
                        updatePlan(docId, occurred, 0, 0, 0);
                    }
                });
            });

            // å¤„ç†ä¿å­˜å®é™…ç›ˆäºæŒ‰é’®ç‚¹å‡»
            plansList.querySelectorAll('.save-pnl-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const docId = e.currentTarget.dataset.id;

                    const grossPnlInput = document.getElementById(`gross-pnl-${docId}`);
                    const feesInput = document.getElementById(`fees-${docId}`);

                    const newGrossPnl = parseFloat(grossPnlInput.value);
                    const newFees = parseFloat(feesInput.value);

                    if (isNaN(newGrossPnl) || isNaN(newFees)) {
                        showMessage('ç›ˆäºå’Œæ‰‹ç»­è´¹å¿…é¡»æ˜¯æ•°å­—ã€‚', 'error');
                        return;
                    }

                    const newNetPnl = newGrossPnl - newFees;

                    const toggle = document.getElementById(`occurred-${docId}`);

                    updatePlan(docId, toggle.checked, newGrossPnl, newFees, newNetPnl);
                });
            });

            // å¤„ç†åˆ é™¤æŒ‰é’®ç‚¹å‡»
            plansList.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const docId = e.currentTarget.dataset.id;
                    deletePlan(docId);
                });
            });
        }


        /**
         * è®¾ç½®å®æ—¶ Firestore ç›‘å¬å™¨ã€‚
         */
        function setupRealtimeListener() {
            if (!db || !userId) return;

            const q = query(getCollectionRef());

            onSnapshot(q, (snapshot) => {
                loadingMessageEl.classList.add('hidden');

                // 1. å°†æ•°æ®è½¬æ¢ä¸ºæ•°ç»„å¹¶ç¼“å­˜
                const plans = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allPlansCache = plans;

                // 2. è®¡ç®—æ±‡æ€»
                const summaries = generateSummaries(plans);
                renderSummaries(summaries); // æ¸²æŸ“æ±‡æ€»éƒ¨åˆ†

                // 3. å¯ç”¨/ç¦ç”¨å¯è§†åŒ–æŒ‰é’®å¹¶é¢„æ¸²æŸ“å›¾è¡¨
                if (summaries.totalSummary.count > 0) {
                     showChartsBtn.disabled = false;
                     renderCharts(summaries);
                } else {
                     showChartsBtn.disabled = true;
                }

                // 4. æ¸²æŸ“åˆ—è¡¨ï¼Œä½¿ç”¨å½“å‰ç­›é€‰æ—¥æœŸ
                renderPlansList(allPlansCache, currentFilterDate);

            }, (error) => {
                console.error("Firestore real-time error:", error);
                loadingMessageEl.textContent = 'åŠ è½½è®°å½•å¤±è´¥ã€‚';
                showMessage('åŠ è½½è®°å½•å¤±è´¥: ' + error.message, 'error');
            });
        }

        // --- ç­›é€‰æ—¥æœŸäº‹ä»¶ç›‘å¬å™¨ ---
        filterDateInput.addEventListener('change', (e) => {
            currentFilterDate = e.target.value;
            if (allPlansCache.length > 0) {
                // ä»…æ›´æ–°åˆ—è¡¨ï¼Œä¸éœ€è¦é‡æ–°è®¡ç®—æ±‡æ€»
                renderPlansList(allPlansCache, currentFilterDate);
            }
        });

        // --- å¯è§†åŒ–æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨ ---
        showChartsBtn.addEventListener('click', () => {
            // æ‰“å¼€æ¨¡æ€æ¡†
            chartModal.classList.remove('hidden');
            // ç¡®ä¿å›¾è¡¨åœ¨ modal å°ºå¯¸ç¡®å®šåé‡æ–°ç»˜åˆ¶ (Chart.js æœ€ä½³å®è·µ)
            if (dailyChartInstance) dailyChartInstance.resize();
            if (productChartInstance) productChartInstance.resize();
        });

        closeChartsBtn.addEventListener('click', () => {
            // å…³é—­æ¨¡æ€æ¡†
            chartModal.classList.add('hidden');
        });


        // --- é¡µé¢åŠ è½½æ—¶çš„åˆå§‹è®¾ç½® ---
        window.addEventListener('load', () => {
            // é¢„å¡«å……æ—¥æœŸä¸ºä»Šå¤©
            const today = new Date().toISOString().substring(0, 10);
            document.getElementById('date').value = today;
            filterDateInput.value = today; // åˆå§‹åŒ–ç­›é€‰æ—¥æœŸ
            summaryMessageEl.textContent = 'å°šæ— å·²æ“ä½œçš„è®°å½•ã€‚'; // åˆå§‹ä¿¡æ¯
        });

    </script>
</body>
</html>